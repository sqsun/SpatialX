% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/spatialvg.R
\name{spark.g}
\alias{spark.g}
\title{SPARK-G: Fast Gaussian-based spatial pattern detection}
\usage{
spark.g(norm_counts, Kmat, covariates, Xdagger, verbose = FALSE)
}
\arguments{
\item{norm_counts}{Normalized gene expression matrix with p genes as rows and
n cells as columns. The data should be variance-stabilized
or otherwise normalized to approximate Gaussian distribution.}

\item{Kmat}{Kernel matrix of dimension n x n that encodes spatial relationships
between cells. Common kernels include Gaussian, cosine, or linear kernels.}

\item{covariates}{Covariate matrix with n cells as rows and c covariates as
columns. Used to adjust for technical and biological confounding
factors. Must include an intercept term if desired.}

\item{Xdagger}{Precomputed pseudo-inverse of the covariate matrix. This can
be computed using \code{pracma::pinv(covariates)}. Precomputing
this matrix improves computational efficiency when testing
multiple genes.}

\item{verbose}{Logical indicating whether to print progress messages and
debugging information. Default is FALSE.}
}
\value{
Returns a data.frame with the following columns:
  \itemize{
    \item \code{pvalues}: P-values testing the significance of spatial patterns
    \item \code{stat_sw}: Test statistics measuring spatial pattern strength
  }
  Rows correspond to genes, with row names preserved from the input norm_counts matrix.
}
\description{
This function implements the SPARK-G method for detecting spatially variable
genes using a Gaussian modeling framework. It is designed for normalized
gene expression data and provides fast, scalable testing of spatial patterns
using kernel-based methods with Satterthwaite approximation for p-value computation.
}
\details{
SPARK-G is a fast method for detecting spatially variable genes that:
\itemize{
  \item Assumes Gaussian-distributed normalized expression data
  \item Uses kernel methods to capture spatial covariance structures
  \item Adjusts for covariates using projection methods
  \item Employs Satterthwaite approximation for efficient p-value computation
  \item Scales linearly with the number of genes
}

The method works by:
\enumerate{
  \item Projecting the kernel matrix to remove covariate effects
  \item Computing the expected value and variance of the test statistic under the null
  \item Calculating a scaled chi-square approximation for the test statistic
  \item Computing p-values using the Satterthwaite approximation
}

The test statistic follows approximately a scaled chi-square distribution:
\deqn{S \sim k \cdot \chi^2_v}
where the scale parameter \eqn{k} and degrees of freedom \eqn{v} are estimated
from the kernel matrix.

Key advantages:
\itemize{
  \item Computational efficiency for large numbers of genes
  \item Robust to various spatial correlation structures
  \item Proper adjustment for technical and biological covariates
  \item No need for permutation or resampling
}
}
\examples{
\dontrun{
# Load required libraries
library(pracma)

# Generate example normalized expression data
n_genes <- 1000
n_cells <- 500
norm_counts <- matrix(rnorm(n_genes * n_cells), nrow = n_genes, ncol = n_cells)
rownames(norm_counts) <- paste0("Gene_", 1:n_genes)

# Create spatial kernel matrix (Gaussian kernel)
spatial_coords <- cbind(x = runif(n_cells), y = runif(n_cells))
dist_matrix <- as.matrix(dist(spatial_coords))
Kmat <- exp(-dist_matrix^2 / (2 * 0.1^2))  # Gaussian kernel with bandwidth 0.1

# Set up covariates (including intercept)
covariates <- cbind(intercept = 1, batch = sample(1:3, n_cells, replace = TRUE))
Xdagger <- pracma::pinv(covariates)  # Precompute pseudo-inverse

# Run SPARK-G
results <- spark.g(
  norm_counts = norm_counts,
  Kmat = Kmat,
  covariates = covariates,
  Xdagger = Xdagger,
  verbose = TRUE
)

# Identify significant spatially variable genes (FDR < 0.05)
sig_genes <- results[p.adjust(results$pvalues, method = "fdr") < 0.05, ]
head(sig_genes[order(sig_genes$pvalues), ])

# Compare with other methods
plot(-log10(results$pvalues), main = "SPARK-G Results",
     xlab = "Gene Rank", ylab = "-log10 p-value")
abline(h = -log10(0.05), col = "red", lty = 2)
}

}
\references{
Sun, S., Zhu, J., & Zhou, X. (2020). Statistical analysis of spatial expression
patterns for spatially resolved transcriptomic studies. Nature Methods, 17(2), 193-200.

Satterthwaite, F. E. (1946). An approximate distribution of estimates of variance
components. Biometrics Bulletin, 2(6), 110-114.
}
\seealso{
\code{\link{spark.x}}, \code{\link{SpatialVG}}, \code{\link[pracma]{pinv}},
\code{\link[stats]{pchisq}}
}
