% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/spatialvg.R
\name{sparkx.sksg}
\alias{sparkx.sksg}
\title{Single gene testing with non-parametric spatial framework (SPARK-X)}
\usage{
sparkx.sksg(
  igene,
  expmat,
  xmat,
  scaleinfo,
  numDim,
  lambda_K,
  loc_inv,
  verbose = TRUE
)
}
\arguments{
\item{igene}{Index of the gene to test within the expression matrix.}

\item{expmat}{Gene expression matrix (sparseMatrix format) with n cells
as rows and p genes as columns.}

\item{xmat}{Covariate matrix with n cells as rows and c covariates as
columns. Used to adjust for technical and biological confounding
factors.}

\item{scaleinfo}{Scaled and centered spatial coordinates matrix with n cells
as rows and d spatial dimensions as columns.}

\item{numDim}{Number of spatial dimensions (typically 2 for 2D spatial data).}

\item{lambda_K}{Eigenvalues of the spatial kernel being tested, representing
the spatial covariance structure.}

\item{loc_inv}{Inverse of the inner product matrix of spatial coordinates,
used in the spatial test statistic computation.}

\item{verbose}{Logical indicating whether to print progress messages.
Useful for debugging and monitoring large analyses.}
}
\value{
Returns a numeric vector of length 2 containing:
  \itemize{
    \item Test statistic measuring the strength of spatial patterning
    \item P-value assessing the significance of the spatial pattern
  }
}
\description{
This function performs spatial pattern testing for a single gene using
the SPARK-X non-parametric framework. It computes test statistics and
p-values by comparing gene expression patterns to spatial covariance
structures while adjusting for potential confounding factors.
}
\details{
This function implements the core statistical test for the SPARK-X method,
which detects spatially variable genes without assuming specific distributional
forms for the expression data. Key aspects:

\itemize{
  \item \strong{Non-parametric approach}: Does not assume Poisson or negative
        binomial distributions, making it robust to various data types
  \item \strong{Covariate adjustment}: Removes effects of known confounding
        factors before spatial testing
  \item \strong{Eigenvalue decomposition}: Uses kernel eigenvalues to capture
        spatial covariance structure
  \item \strong{Davies/Liu approximation}: Computes exact p-values using
        quadratic form distributions with fallback to approximation when needed
}

The test statistic is computed as:
\deqn{S = \frac{1}{\sigma^2} \cdot Y^T H L^{-1} H^T Y \cdot n}
where:
\itemize{
  \item \eqn{Y} is the gene expression vector
  \item \eqn{H} is the projection matrix for covariates
  \item \eqn{L} is the spatial coordinate matrix
  \item \eqn{n} is the number of cells
  \item \eqn{\sigma^2} is the variance estimate
}

The p-value is computed using the Davies method for quadratic forms of
normal variables, with fallback to Liu approximation when necessary.
}
\examples{
\dontrun{
# Load required libraries
library(Matrix)
library(CompQuadForm)

# Generate example data
n_cells <- 100
n_genes <- 50
n_covariates <- 3
n_dims <- 2

# Expression matrix (sparse)
expmat <- Matrix::Matrix(rpois(n_cells * n_genes, 5), 
                        nrow = n_cells, ncol = n_genes, sparse = TRUE)

# Covariate matrix
xmat <- matrix(rnorm(n_cells * n_covariates), nrow = n_cells)

# Spatial coordinates (centered and scaled)
scaleinfo <- scale(matrix(runif(n_cells * n_dims), ncol = n_dims))

# Kernel eigenvalues
lambda_K <- runif(n_dims, 0.5, 2.0)

# Inverse of location inner product
loc_inv <- solve(crossprod(scaleinfo))

# Test a single gene
result <- sparkx.sksg(
  igene = 1,
  expmat = expmat,
  xmat = xmat,
  scaleinfo = scaleinfo,
  numDim = n_dims,
  lambda_K = lambda_K,
  loc_inv = loc_inv,
  verbose = TRUE
)

# Test multiple genes in parallel
all_results <- parallel::mclapply(
  1:10,
  sparkx.sksg,
  expmat = expmat,
  xmat = xmat,
  scaleinfo = scaleinfo,
  numDim = n_dims,
  lambda_K = lambda_K,
  loc_inv = loc_inv,
  verbose = FALSE,
  mc.cores = 4
)

# Extract p-values
pvals <- sapply(all_results, function(x) x[2])
test_stats <- sapply(all_results, function(x) x[1])
}

}
\references{
Zhu, J., Sun, S., & Zhou, X. (2021). SPARK-X: non-parametric modeling enables
scalable and robust detection of spatial expression patterns for large spatial
transcriptomic studies. Genome Biology, 22(1), 184.

Davies, R. B. (1980). The Distribution of a Linear Combination of
Ï‡2 Random Variables. Journal of the Royal Statistical Society.
Series C (Applied Statistics), 29(3), 323-333.
}
\seealso{
\code{\link{sparkx_pval}}, \code{\link{SpatialVG}},
\code{\link[CompQuadForm]{davies}}, \code{\link[CompQuadForm]{liu}}
}
