% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/spatialvg.R
\name{spark.x}
\alias{spark.x}
\title{SPARK-X: Non-parametric spatial pattern detection for transcriptomics}
\usage{
spark.x(counts, infomat, X_mat = NULL, mc_cores = 1, verbose = TRUE)
}
\arguments{
\item{counts}{Gene expression matrix with n cells as rows and p genes as columns.
Can be a dense matrix, data.frame, or sparseMatrix. For large
datasets, sparseMatrix format is recommended for memory efficiency.}

\item{infomat}{Spatial information matrix with n cells as rows and d spatial
dimensions as columns. Typically contains spatial coordinates
(x, y) and optionally additional spatial features.}

\item{X_mat}{Optional covariate matrix with n cells as rows and c covariates
as columns. Used to adjust for technical and biological confounding
factors such as batch effects, sequencing depth, or cell cycle stage.}

\item{mc_cores}{Number of CPU cores to use for parallel computation. Default is 1.
For large datasets, increasing this value can significantly
reduce computation time.}

\item{verbose}{Logical indicating whether to print progress messages and
debugging information. Default is TRUE.}
}
\value{
Returns a data.frame with the following columns:
  \itemize{
    \item \code{stat}: Test statistic measuring the strength of spatial patterning
    \item \code{pval}: P-value assessing the significance of spatial pattern
  }
  Rows correspond to genes, with row names preserved from the input counts matrix.
}
\description{
This function implements the SPARK-X method for detecting spatially variable
genes in spatial transcriptomics data using a non-parametric framework.
It tests for spatial patterns in gene expression without assuming specific
distributional forms, making it robust and scalable for large datasets.
}
\details{
SPARK-X is a non-parametric method for detecting spatially variable genes that:
\itemize{
  \item Does not assume specific distributional forms (e.g., Poisson, negative binomial)
  \item Handles both raw counts and normalized expression data
  \item Adjusts for technical and biological confounding factors
  \item Scales efficiently to large datasets with thousands of cells and genes
  \item Uses efficient linear algebra and parallel computation
}

The method works by:
\enumerate{
  \item Projecting gene expression onto spatial coordinate basis functions
  \item Computing test statistics that measure correspondence between expression
        and spatial patterns
  \item Adjusting for covariates if provided
  \item Computing p-values using eigenvalue decomposition and Davies/Liu methods
}

Key advantages over parametric methods:
\itemize{
  \item Robust to overdispersion and zero-inflation in count data
  \item No need for parameter tuning or distributional assumptions
  \item Fast computation even for large spatial datasets
  \item Maintains good statistical power across diverse data types
}
}
\examples{
\dontrun{
# Load required libraries
library(Matrix)

# Generate example spatial transcriptomics data
n_cells <- 500
n_genes <- 1000
n_dims <- 2

# Expression matrix (sparse for efficiency)
counts <- Matrix::Matrix(rpois(n_cells * n_genes, 5), 
                        nrow = n_cells, ncol = n_genes, sparse = TRUE)
rownames(counts) <- paste0("Cell_", 1:n_cells)
colnames(counts) <- paste0("Gene_", 1:n_genes)

# Spatial coordinates
infomat <- cbind(x = runif(n_cells), y = runif(n_cells))

# Run SPARK-X without covariates
results <- spark.x(
  counts = t(counts),  # Note: spark.x expects genes as rows
  infomat = infomat,
  mc_cores = 4,
  verbose = TRUE
)

# Run with covariates (e.g., batch effects, sequencing depth)
covariates <- cbind(
  batch = sample(1:3, n_cells, replace = TRUE),
  depth = rnorm(n_cells)
)

results_adj <- spark.x(
  counts = t(counts),
  infomat = infomat,
  X_mat = covariates,
  mc_cores = 4
)

# Identify significant spatially variable genes (FDR < 0.05)
sig_genes <- results[which(p.adjust(results$pval, method = "fdr") < 0.05), ]
head(sig_genes[order(sig_genes$pval), ])

# Compare with and without covariate adjustment
plot(-log10(results$pval), -log10(results_adj$pval),
     xlab = "-log10 p-value (unadjusted)",
     ylab = "-log10 p-value (adjusted)")
abline(0, 1, col = "red")
}

}
\references{
Zhu, J., Sun, S., & Zhou, X. (2021). SPARK-X: non-parametric modeling enables
scalable and robust detection of spatial expression patterns for large spatial
transcriptomic studies. Genome Biology, 22(1), 184.
}
\seealso{
\code{\link{sparkx.sksg}}, \code{\link{sparkx_pval}}, \code{\link{SpatialVG}},
\code{\link[CompQuadForm]{davies}}
}
