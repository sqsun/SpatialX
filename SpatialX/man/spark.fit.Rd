% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/spatialvg.R
\name{spark.fit}
\alias{spark.fit}
\title{Fit spatial models for various distribution families}
\usage{
spark.fit(model0, maxiter = 500, tol = 1e-05, verbose = FALSE)
}
\arguments{
\item{model0}{An initial generalized linear model object fitted by \code{glm}.
This serves as the starting point for spatial model fitting.
Must be of family "gaussian", "poisson", or "binomial".}

\item{maxiter}{Maximum number of iterations for the estimation algorithm.
Default is 500.}

\item{tol}{Tolerance threshold for convergence. The algorithm stops when
parameter changes fall below this value. Default is 1e-5.}

\item{verbose}{Logical indicating whether to print iteration progress and
debugging information. Default is FALSE.}
}
\value{
Returns a list with the following components (specific components
        may vary by family):
  \itemize{
    \item \code{theta}: Estimated variance components
    \item \code{coefficients}: Estimated fixed effects coefficients
    \item \code{linear.predictors}: Linear predictors (η = Xβ + offset)
    \item \code{fitted.values}: Fitted values on the response scale
    \item \code{Y}: Working response vector
    \item \code{residuals}: Response residuals (y - μ)
    \item \code{Py}: Projected working response vector
    \item \code{X}: Design matrix for fixed effects
    \item \code{D}: Diagonal weights matrix for the working response
    \item \code{converged}: Logical indicating whether the algorithm converged
          (for Poisson and Binomial families)
  }
}
\description{
This function fits spatial models for Gaussian, Poisson, and Binomial
distributions using appropriate estimation methods. For Gaussian data,
it uses direct calculation; for count and binary data, it employs the
Average Information algorithm with iterative refinement to handle
variance component estimation and boundary cases.
}
\details{
This function provides a unified interface for fitting spatial models
across different distribution families:

\describe{
  \item{Gaussian}{Uses direct calculation of variance components based
        on residuals. Fast and exact for normally distributed data.}
  \item{Poisson}{Employs the Average Information algorithm with iterative
        refinement to handle overdispersion and spatial correlation in
        count data.}
  \item{Binomial}{Uses the same iterative approach as Poisson but for
        binary/binary data, handling spatial correlation in binary outcomes.}
}

For Poisson and Binomial families, the function implements an iterative
refinement process that:
\enumerate{
  \item Fits the initial model using the Average Information algorithm
  \item Identifies variance components that are effectively zero
  \item Refits the model with these components fixed
  \item Repeats until stability is achieved or maximum iterations reached
}

This approach ensures robust estimation even when some variance components
are at the boundary of the parameter space.
}
\examples{
\dontrun{
# Gaussian spatial model
set.seed(123)
n <- 100
x <- rnorm(n)
y_gaussian <- 1 + 0.5*x + rnorm(n, sd = 0.5)
model0_gauss <- glm(y_gaussian ~ x, family = gaussian)
result_gauss <- spark.fit(model0_gauss, verbose = TRUE)

# Poisson spatial model for count data
mu_pois <- exp(1 + 0.3*x + rnorm(n, sd = 0.2))
y_pois <- rpois(n, mu_pois)
model0_pois <- glm(y_pois ~ x, family = poisson)
result_pois <- spark.fit(model0_pois, maxiter = 100, tol = 1e-4)

# Binomial spatial model for binary data
prob_bin <- plogis(0.5 + 0.4*x + rnorm(n, sd = 0.3))
y_bin <- rbinom(n, 1, prob_bin)
model0_bin <- glm(y_bin ~ x, family = binomial)
result_bin <- spark.fit(model0_bin, verbose = TRUE)

# Compare results across families
summary(result_gauss$coefficients)
summary(result_pois$coefficients)
summary(result_bin$coefficients)
}

}
\references{
Gilmour, A. R., Thompson, R., & Cullis, B. R. (1995). Average information
REML: an efficient algorithm for variance parameter estimation in linear
mixed models. Biometrics, 51(4), 1440-1450.

Breslow, N. E., & Clayton, D. G. (1993). Approximate inference in
generalized linear mixed models. Journal of the American Statistical
Association, 88(421), 9-25.
}
\seealso{
\code{\link{spark.ai}}, \code{\link{glm}}, \code{\link{SpatialVG}}
}
