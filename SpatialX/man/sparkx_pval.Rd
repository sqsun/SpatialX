% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/spatialvg.R
\name{sparkx_pval}
\alias{sparkx_pval}
\title{Calculate SPARK-X p-values using Davies method}
\usage{
sparkx_pval(igene, lambda_G, lambda_K, allstat)
}
\arguments{
\item{igene}{Index of the gene for which to compute the p-value. This
index corresponds to the position in the lambda_G and allstat
vectors.}

\item{lambda_G}{A p-length numeric vector of eigenvalues for all genes.
These eigenvalues are typically derived from the gene
expression covariance structure.}

\item{lambda_K}{A d-length numeric vector of eigenvalues for the spatial
kernel being tested. These capture the spatial covariance
structure.}

\item{allstat}{A p-length numeric vector of test statistics for all genes.
These statistics measure the strength of spatial patterning
for each gene.}
}
\value{
Returns a single numeric value representing the p-value for the
        specified gene. If the Davies method fails or returns a non-positive
        p-value, the Liu approximation is used instead. Returns NA if
        both methods fail.
}
\description{
This function computes p-values for the SPARK-X method using the Davies
algorithm for quadratic forms of normal variables. It is used internally
in spatial pattern detection to assess the significance of spatial
expression patterns for individual genes.
}
\details{
The SPARK-X method tests for spatially variable gene expression by
examining the correspondence between gene expression patterns and
spatial covariance structures. This function implements the statistical
test using the Davies algorithm, which computes the exact distribution
of quadratic forms of normal variables.

The test statistic follows a mixture of chi-square distributions under
the null hypothesis of no spatial pattern. The eigenvalues (lambda_G
and lambda_K) define this mixture distribution, and the Davies algorithm
computes the probability of observing a test statistic as extreme as
the observed value.

Key features:
\itemize{
  \item Uses Davies algorithm for exact p-value computation
  \item Falls back to Liu approximation when Davies fails
  \item Handles numerical edge cases gracefully
  \item Efficiently computes p-values gene by gene
}

The function is typically used in parallel across multiple genes to
enable scalable spatial pattern detection in large datasets.
}
\examples{
\dontrun{
# Generate example eigenvalues and test statistics
n_genes <- 100
n_kernels <- 50

lambda_G <- runif(n_genes, 0.1, 2.0)  # Gene eigenvalues
lambda_K <- runif(n_kernels, 0.5, 3.0) # Kernel eigenvalues
allstat <- rchisq(n_genes, df = 2)     # Test statistics

# Compute p-value for a specific gene
gene_index <- 5
pval <- sparkx_pval(
  igene = gene_index,
  lambda_G = lambda_G,
  lambda_K = lambda_K,
  allstat = allstat
)

# Compute p-values for all genes in parallel
all_pvals <- parallel::mclapply(
  1:n_genes,
  sparkx_pval,
  lambda_G = lambda_G,
  lambda_K = lambda_K,
  allstat = allstat,
  mc.cores = 4
)

# Identify significant genes
significant_genes <- which(unlist(all_pvals) < 0.05)
}

}
\references{
Davies, R. B. (1980). The Distribution of a Linear Combination of
Ï‡2 Random Variables. Journal of the Royal Statistical Society.
Series C (Applied Statistics), 29(3), 323-333.

Liu, H., et al. (2009). Accurate and efficient p-value calculation
for the generalized chi-square distribution. Journal of
Computational Biology, 16(10), 1389-1398.
}
\seealso{
\code{\link[CompQuadForm]{davies}}, \code{\link[CompQuadForm]{liu}},
\code{\link{SpatialVG}}
}
